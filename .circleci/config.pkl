amends "package://pkg.pkl-lang.org/pkl-project-commons/pkl.impl.circleci@1.2.0#/PklCI.pkl"

local testJobs = jobs.keys.filter((it) -> it.startsWith("test"))

prb {
  jobs {
    ...testJobs
  }
}

main {
  jobs {
    ...testJobs
  }
}

local PKL_VERSION = "0.30.0"

jobs {
  ["test"] {
    docker {
      new {
        image = "swift:5.9"
      }
    }
    steps {
      "checkout"
      new RunStep {
        command = """
          apt-get -y update
          apt-get -y install curl
          curl -L -o pkl.bin https://github.com/apple/pkl/releases/download/\(PKL_VERSION)/pkl-linux-amd64
          chmod +x pkl.bin
          PKL_EXEC=$(pwd)/pkl.bin swift test
          """
      }
    }
  }
  ["test-license-headers"] {
    docker {
      new {
        image = "ghcr.io/korandoru/hawkeye"
      }
    }
    steps {
      "checkout"
      new RunStep {
        command = "/bin/hawkeye check --fail-if-unknown"
      }
    }
  }
}
